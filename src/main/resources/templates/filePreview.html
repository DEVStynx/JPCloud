<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="'JPCloud - ' + ${fileName}">JPCloud - File</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/preview.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="/js/client.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.min.js"></script>
    <style>
        .preview-container {
            width: 95%;
            height: 80vh;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #f5f5f5;
        }

        #preview-content {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .pdf-canvas {
            margin: 10px auto;
            display: block;
        }

        .image-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }

        .text-preview {
            margin: 20px;
            white-space: pre-wrap;
            overflow: auto;
            height: calc(100% - 40px);
            font-family: monospace;
        }

        .download-message {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }

        .download-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="title-bar">
    <h1 class="title"><a href="/dashboard" style="text-decoration: none; color: var(--text-primary);">JPCloud</a></h1>
    <div th:text="${fileName}" style="margin-left: 20px; font-size: 1.2rem;"></div>
</div>
<div class="create-new-section">
    <button class="round-button" th:data-path="${path}"><img src="/images/download.png" alt="Download"></button></div>
<div class="preview-container">
    <div id="preview-content"></div>
</div>

<script th:inline="javascript">
    // PDF.js Worker konfigurieren
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // Aus Controller übergebene Werte
    const fileUrl = /*[[${fileUrl}]]*/ '';
    const fileName = /*[[${fileName}]]*/ '';
    const fileType = /*[[${fileType}]]*/ '';
    const previewContainer = document.getElementById('preview-content');

    // CSRF-Token für authentifizierte Anfragen
    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
    const csrfHeaderName = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

    // Je nach Dateityp unterschiedliche Vorschau anzeigen
    switch(fileType) {
        case 'pdf':
            loadPDF();
            break;
        case 'jpg': case 'jpeg': case 'png': case 'gif': case 'svg':
            loadImage();
            break;
        case 'txt': case 'json': case 'xml': case 'md': case 'html':
        case 'css': case 'js': case 'java': case 'properties': case 'yml':
            loadText();
            break;
        default:
            showDownloadMessage();
    }

    // PDF mit PDF.js anzeigen
    function loadPDF() {
        // Authentifizierte Anfrage mit CSRF-Token
        fetch(fileUrl, {
            headers: {
                [csrfHeaderName]: csrfToken
            }
        })
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                return pdfjsLib.getDocument(url).promise;
            })
            .then(function(pdf) {
                // Alle Seiten rendern
                for (let i = 1; i <= pdf.numPages; i++) {
                    pdf.getPage(i).then(function(page) {
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale });

                        // Canvas für jede Seite erstellen
                        const canvas = document.createElement('canvas');
                        canvas.className = 'pdf-canvas';
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        previewContainer.appendChild(canvas);

                        // Seite rendern
                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                    });
                }
            })
            .catch(function(error) {
                console.error('Fehler beim Laden des PDFs:', error);
                showDownloadMessage();
            });
    }

    // Bild anzeigen
    function loadImage() {
        // Authentifizierte Anfrage mit fetch und Blob
        fetch(fileUrl, {
            headers: {
                [csrfHeaderName]: csrfToken
            }
        })
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.className = 'image-preview';
                img.src = url;
                previewContainer.appendChild(img);
            })
            .catch(error => {
                console.error('Fehler beim Laden des Bildes:', error);
                showDownloadMessage();
            });
    }

    // Textdatei anzeigen
    function loadText() {
        fetch(fileUrl, {
            headers: {
                [csrfHeaderName]: csrfToken
            }
        })
            .then(response => response.text())
            .then(text => {
                const pre = document.createElement('pre');
                pre.className = 'text-preview';
                pre.textContent = text;
                previewContainer.appendChild(pre);
            })
            .catch(error => {
                console.error('Fehler beim Laden der Textdatei:', error);
                showDownloadMessage();
            });
    }

    // Download-Nachricht für nicht unterstützte Dateitypen
    function showDownloadMessage() {
        previewContainer.innerHTML = `
                <div class="download-message">
                    Diese Datei kann nicht direkt angezeigt werden.
                    <button class="download-button" onclick="window.location.href='${fileUrl}'">
                        Herunterladen
                    </button>
                </div>
            `;
    }

</script>
</body>
</html>